<!doctype html>
<html>
    <head>
        <title>Emoji Garden</title>
        <style>
            body {
                background-color: #90ee90;
                margin: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                font-family: monospace;
            }
            #grid {
                display: grid;
                grid-template-columns: repeat(40, 1fr);
                gap: 2px;
                background-color: #006400;
                padding: 10px;
                border-radius: 10px;
            }
            .cell {
                width: 30px;
                height: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 20px;
                background-color: #98fb98;
                border-radius: 4px;
                position: relative;
            }
            .player-tooltip {
                position: absolute;
                top: -20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <div style="text-align: center;">
                <h1 style="color: #006400; margin: 0;">Emoji Garden</h1>
                <div style="font-size: 12px;">
                    currently in the garden: <span id="player-count">0</span>
                </div>
            </div>
            <div id="grid"></div>
        </div>
        <script>
            const grid = document.getElementById("grid");
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log("WebSocket connected");
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected");
            };

            let gridWidth = 40;  // Default size, will be updated from server
            let gridHeight = 30; // Default size, will be updated from server

            function initializeGrid() {
                grid.innerHTML = ''; // Clear existing grid
                grid.style.gridTemplateColumns = `repeat(${gridWidth}, 1fr)`;
                
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                    const cell = document.createElement("div");
                    cell.className = "cell";
                    cell.id = `cell-${x}-${y}`;
                    grid.appendChild(cell);
                    }
                }
            }

            initializeGrid();

            // Handle keyboard input
            document.addEventListener("keydown", (e) => {
                const keyMap = {
                    ArrowUp: "ArrowUp",
                    ArrowDown: "ArrowDown",
                    ArrowLeft: "ArrowLeft",
                    ArrowRight: "ArrowRight",
                    w: "ArrowUp",
                    s: "ArrowDown",
                    a: "ArrowLeft",
                    d: "ArrowRight",
                    W: "ArrowUp",
                    S: "ArrowDown",
                    A: "ArrowLeft",
                    D: "ArrowRight",
                };

                if (e.code === "Space") {
                    const message = JSON.stringify({
                        type: "plant"
                    });
                    ws.send(message);
                    e.preventDefault();
                } else {
                    const mappedKey = keyMap[e.key];
                    console.log(e.key, mappedKey);
                    if (mappedKey) {
                    const message = JSON.stringify({
                        type: "move",
                        direction: mappedKey,
                    });
                    console.log("Sending message:", message);
                    ws.send(message);
                }
            });

            // WebSocket message handling
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                // Update grid size if needed
                if (data.width !== gridWidth || data.height !== gridHeight) {
                    gridWidth = data.width;
                    gridHeight = data.height;
                    initializeGrid();
                }

                console.log(data.players);
                // Clear all cells
                document.querySelectorAll(".cell").forEach((cell) => {
                    cell.textContent = "";
                });

                // Draw landscape and flowers
                data.landscape.forEach((row, y) => {
                    row.forEach((cell, x) => {
                        const cellElement = document.getElementById(`cell-${x}-${y}`);
                        if (cell) {
                            cellElement.textContent = cell;
                        } else if (data.flowers.some(([fx, fy]) => fx === x && fy === y)) {
                            cellElement.textContent = "ðŸŒ¸";
                        } else {
                            cellElement.textContent = "";
                        }
                    });
                });

                // Update player count
                document.getElementById("player-count").textContent = Object.keys(data.players).length;
                
                // Draw players
                Object.values(data.players).forEach((pos) => {
                    const cell = document.getElementById(
                        `cell-${pos.x}-${pos.y}`,
                    );
                    cell.textContent = pos.emoji;

                    // Add tooltip with player number
                    const tooltip = document.createElement("div");
                    tooltip.className = "player-tooltip";
                    tooltip.textContent = `P${pos.player_num}`;
                    cell.appendChild(tooltip);
                });
            };
        </script>
    </body>
</html>
